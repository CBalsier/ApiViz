<!DOCTYPE html>
<html>


	{# IMPORTS #}
	<head>

		{# USUAL META #}
		<title>CIS | {{ languages_dict[site_section][language] }}</title>

		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		
		{# CUSTOM APP META DATA #}
		<meta name="keywords" 		content="{{ app_metas.keywords }}">
		<meta name="author"			content="{{ app_metas.authors }}">
		<meta name="description" 	content="{{ app_metas.description }}">
		
		<meta name="config_name" 	content="{{ config_name }}">

		<meta name="user_token" 	content="test_token">

		{# force refresh (for instance : every 1800 seconds = 30 minutes ) #}
		{# cf trick here : https://stackoverflow.com/questions/1922910/force-browser-to-clear-cache/9516207 #}
		<meta http-equiv="refresh" content="{{ app_metas.refresh_page }}">
		
		{# GOOGLE INDEXING / cf : https://support.google.com/webmasters/answer/6259634?hl=en #}
		<meta name="google-site-verification" content="vSnFdoQsEBUIOqbQWr3h1SRXb1mu0ttVN0fo4H25XNk" />

 
		

		{# MIX PANEL - METRICS --- only in production mode #}
		{% if config_name == "production" %}
			<script type="text/javascript">
				(function(e,a){if(!a.__SV){var b=window;try{var c,l,i,j=b.location,g=j.hash;c=function(a,b){return(l=a.match(RegExp(b+"=([^&]*)")))?l[1]:null};g&&c(g,"state")&&(i=JSON.parse(decodeURIComponent(c(g,"state"))),"mpeditor"===i.action&&(b.sessionStorage.setItem("_mpcehash",g),history.replaceState(i.desiredHash||"",e.title,j.pathname+j.search)))}catch(m){}var k,h;window.mixpanel=a;a._i=[];a.init=function(b,c,f){function e(b,a){var c=a.split(".");2==c.length&&(b=b[c[0]],a=c[1]);b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,
				0)))}}var d=a;"undefined"!==typeof f?d=a[f]=[]:f="mixpanel";d.people=d.people||[];d.toString=function(b){var a="mixpanel";"mixpanel"!==f&&(a+="."+f);b||(a+=" (stub)");return a};d.people.toString=function(){return d.toString(1)+".people (stub)"};k="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config reset people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
				for(h=0;h<k.length;h++)e(d,k[h]);a._i.push([b,c,f])};a.__SV=1.2;b=e.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";c=e.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}})(document,window.mixpanel||[]);
				mixpanel.init("efeeb2cdf388e67727ed68fcdeea898f");
			</script>
		{% endif %}


		{# GOOGLE ANALYTICS - METRICS #}


		{# BULMA EXTENSIONS FOR WHOLE WEBSITE #}
		{# <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bulma-ext/bulma-checkradio.min.css') }}">
		<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bulma-ext/bulma-tooltip.min.css') }}">
		<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bulma-ext/bulma-badge.min.css') }}"> #}
		{# <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bulma-ext/bulma-divider.min.css') }}">
		<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bulma-ext/bulma-timeline.min.css') }}">
		<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bulma-ext/bulma-tagsinput.min.css') }}"> #}
		<script type="text/javascript" language="javascript" src="{{ url_for('static', filename='css/bulma-ext/bulma-tagsinput.min.js') }}"></script>
		{# <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bulma-ext/bulma-steps.min.css') }}"> #}
		<script type="text/javascript" language="javascript" src="{{ url_for('static', filename='css/bulma-ext/bulma-steps.min.js') }}"></script>
		<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bulma-ext/bulma-carousel.min.css') }}">
		<script type="text/javascript" language="javascript" src="{{ url_for('static', filename='css/bulma-ext/bulma-carousel.min.js') }}"></script>

		{# BULMA #}
		{# <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css"> #}
		<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bulma-custom.css') }}?version=0.0.3">
		<script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
		

		{# VUE.JS #}
		<script src="https://unpkg.com/vuex@3.0.1/dist/vuex.js"></script> 
		{% if config_name == "production" %}
			<!-- production version, optimized for size and speed -->
			<script src="https://cdn.jsdelivr.net/npm/vue"></script> 
		{% else %}
			<!-- development version, includes helpful console warnings -->
			<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
		{% endif %}


		{# RECAPTCHA - SECURITY #}


		{# CRISP - CHAT #}


		{# LEAFLET / cf : http://leafletjs.com/ #}
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"></script>


		{# CHARTS - VIZ / cf : http://www.chartjs.org/ #}
		<script type="text/javascript" language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>		


		{# DATATABLE - VIZ #}
		<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css">
		<script type="text/javascript" language="javascript" src="https://code.jquery.com/jquery-1.12.4.js"></script>
		<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>


		{# CUSTOM STYLES ---> TO FIX #}
		<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/cis-custom.css') }}?version=0.0.4">


        <style>
        .map { 
            margin-top: calc(70px + 52px);
            height: 500px; 
            width: 80%;
            margin-left: 10%;
        }
        </style>
        <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
        <script>
        'use strict';

        document.addEventListener('DOMContentLoaded', () => {
            const mymap = L.map( document.querySelector('.map') ).setView([46.2276, 2.2137], 6);

            L.tileLayer('https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(mymap);

            // fetch data
            fetch('http://cis-openscraper.com/api/data?token=pwa&results_per_page=200')
            .then(r => r.json())
            .then(data => {
                const {query_results: projects} = data;

                console.info('projects', projects);

                const projectWithValidAddress = projects
                .filter(p => Array.isArray(p['adresse du projet']))




                const addresses = projectWithValidAddress.map(p => p['adresse du projet'].join(' '))
                
                console.info('addr', addresses);

                const adressesCSV = 'adresse\n' + addresses.join('\n')

                const adresseCSVBANBody = new FormData();
                adresseCSVBANBody.append('data', new File([adressesCSV], 'adresses.csv'))


                return fetch('https://api-adresse.data.gouv.fr/search/csv/', {
                    method: 'POST',
                    body: adresseCSVBANBody,
                })
                .then(r => r.text())
                .then(geolocsTxt => {
                    const geolocs = d3.csvParse(geolocsTxt);

                    console.info('geolocs', geolocs)

                    projectWithValidAddress.map((p, i) => {
                        p.geoloc = geolocs[i];
                    })

                    for(const p of projectWithValidAddress){
                        L.marker({lon: p.geoloc.longitude, lat: p.geoloc.latitude}).addTo(mymap)
                        .bindPopup(`<strong>${p['titre du projet']}</strong><br>${(p['tags'] || []).join(' ')}`);
                    }


                });

            })
            .catch(err => console.error('carto err', err))
        })

        </script>
		
		<script defer src="/static/build/bundle.js"></script>

	</head>



	{# MAIN CONTENTS #}
	<body>

		<nav></nav>

		<div id="navbar-filters"></div>

        <div class="map"></div>

		<footer></footer>
	
	</body>



	{# note : hack refresh cache adding this : ?version=0.0.1 after brackets #}

	{# TEMPORARY SOLUTION #}
	<!-- CUSTOM JS FILTERS VARS / TEMPORARY WHILE SOLIDATA IS IN DEVELOPMENT -->
	{# <script type="text/javascript" language="javascript" src="{{ url_for('static', filename='js/cis-getjson-nomenclature.js') }}"></script> #}
	{# <script type="text/javascript" language="javascript" src="{{ url_for('static', filename='js/cis-tags-nomenclature.js') }}"></script> #}
	{# <script type="text/javascript" language="javascript" src="{{ url_for('static', filename='json/CHOICES_FILTERS.js') }}"></script> #}
	<script type="text/javascript" language="javascript" src="{{ url_for('static', filename='json/CHOICES_FILTERS_TAGS.js') }}"></script>
	<script type="text/javascript" language="javascript" src="{{ url_for('static', filename='json/CHOICES_FILTERS_PARTNERS.js') }}"></script>
	<script type="text/javascript" language="javascript" src="{{ url_for('static', filename='json/CHOICES_FILTERS_GEOLOC.js') }}"></script>
	{# <script type="text/javascript" language="javascript" src="{{ url_for('static', filename='json/CATEGORIES_CIS_DICT.js') }}"></script> #}
	<script type="text/javascript" language="javascript" src="{{ url_for('static', filename='json/CATEGORIES_CIS_DICT_FLAT.js') }}"></script>
	{# <script type="text/javascript" language="javascript" src="{{ url_for('static', filename='json/NOMENCLATURE_CIS_DICT.js') }}"></script> #}
	{# <script type="text/javascript" language="javascript" src="{{ url_for('static', filename='json/NORMALIZATION_TAGS_SOURCES_CIS.js') }}"></script> #}
	<script type="text/javascript" language="javascript" src="{{ url_for('static', filename='json/NORMALIZATION_TAGS_SOURCES_CIS_DICT.js') }}"></script>


	<!-- CUSTOM UTIL JS FOR BULMA -->
	<script type="text/javascript" language="javascript" src="{{ url_for('static', filename='js/cis-navbar-burger.js') }}?version=0.0.1"></script>
	<script type="text/javascript" language="javascript" src="{{ url_for('static', filename='js/cis-modals-toggler.js') }}?version=0.0.1"></script>
	<script type="text/javascript" language="javascript" src="{{ url_for('static', filename='js/cis-notification-dismisser.js') }}?version=0.0.1"></script>
	<script type="text/javascript" language="javascript" src="{{ url_for('static', filename='js/cis-counter.js') }}?version=0.0.2"></script>


	{# IMPORT VUE AND AJAX CIS JS FILES #}

	{# {% if user_infos.is_authenticated == True %} #}

		<!-- CUSTOM JS FILTERS TOGGLING -->
		<script type="text/javascript" language="javascript" src="{{ url_for('static', filename='js/cis-filters-toggler.js') }}?version=0.0.1"></script>

		{% if site_section not in ['preferences', 'landing'] %}

			<!-- CUSTOM JS FOR AJAX CALLS -->
			<script type="text/javascript" language="javascript" src="{{ url_for('static', filename='js/cis-ajax-calls.js') }}?version=0.0.5"></script>
			
			<!-- CUSTOM VUE JS -->
			<script type="text/javascript" language="javascript" src="{{ url_for('static', filename='js/cis-vue-store.js') }}?version=0.0.1"></script>
			<script type="text/javascript" language="javascript" src="{{ url_for('static', filename='js/cis-vue-components.js') }}?version=0.0.6"></script>
			<script type="text/javascript" language="javascript" src="{{ url_for('static', filename='js/cis-vue-controllers.js') }}?version=0.0.6"></script>

			<!-- CUSTOM JS SEARCH CALLER -->
			{# <script type="text/javascript" language="javascript" src="{{ url_for('static', filename='js/cis-search-caller.js') }}"></script> #}

		{% endif %}

	{# {% endif %} #}




	

	<!-- CUSTOM MIXPANEL CALLS  -->

	{% if config_name == "production" %}

	<script type="text/javascript">
		// https://blog.toky.co/mixpanels-basic-tutorial-guide-to-start-custom-event-tracking-on-your-website/
		console.log("sending data to Mix Panel")
		mixpanel.track("page_view");
		mixpanel.identify("{{ user_infos.userOID }}");

		mixpanel.people.set({
			"$id"	: "{{ user_infos.userOID }}",		// only special properties need the $
			"$email": "{{ user_infos.userEmail }}",		// 
			
			//"$created": "2011-03-16 16:53:54",
			//"$last_login": new Date(),         // properties can be dates...
			//"credits": 150,                    // ...or numbers
		});


	</script> 

	

	<script type="text/javascript" language="javascript" src="{{ url_for('static', filename='js/cis-mixpanel-metrics.js') }}"></script>
	
	{% endif %}

</html>


